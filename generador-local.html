<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Videos Local - Runway ML Gen-4 Turbo</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .generator-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .download-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 2rem;
        }

        .btn-download {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--success-color) 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .btn-select-folder {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .btn-select-folder:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
        }

        .folder-info {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .folder-info.visible {
            display: block;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .image-preview.visible {
            display: block;
        }

        .btn-generate {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-generate:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            display: none;
        }

        .status-panel.visible {
            display: block;
        }

        .status-panel.loading {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }

        .status-panel.success {
            background-color: #d4edda;
            border-left: 5px solid var(--success-color);
        }

        .status-panel.error {
            background-color: #f8d7da;
            border-left: 5px solid var(--danger-color);
        }

        .video-preview {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .video-preview video {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .info-box {
            padding: 1rem;
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Generador de Videos Local - Runway Gen-4 Turbo</h1>
            <p class="subtitle">Genera videos de 9-10 segundos a partir de im√°genes locales</p>
        </div>
    </header>

    <nav id="navbar">
        <div class="container">
            <ul>
                <li><a href="index.html">Investigaci√≥n Principal</a></li>
                <li><a href="generador-local.html">Generador Local</a></li>
                <li><a href="cuestionario.html">Cuestionario</a></li>
            </ul>
        </div>
    </nav>

    <main class="container generator-container">
        <!-- Pesta√±as -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('generator')">Generador de Videos</button>
            <button class="tab" onclick="switchTab('stats')">Estad√≠sticas del Cuestionario</button>
        </div>

        <!-- TAB 1: Generador de Videos -->
        <div id="tab-generator" class="tab-content active">
        <div class="section">
            <h2>Configuraci√≥n de Generaci√≥n</h2>

            <div class="info-box">
                <h4>‚ÑπÔ∏è C√≥mo funciona:</h4>
                <ol style="margin: 0.5rem 0 0 1.5rem;">
                    <li>Selecciona una carpeta que contenga una imagen (JPG, PNG, etc.)</li>
                    <li>El sistema detectar√° autom√°ticamente la primera imagen en la carpeta</li>
                    <li>Se generar√°n 2 videos (9-10 seg) basados en esa imagen usando Gen-4 Turbo:
                        <ul>
                            <li><strong>Alta Calidad:</strong> ~8-10 MB</li>
                            <li><strong>Baja Calidad:</strong> ~2-3 MB</li>
                        </ul>
                    </li>
                    <li>Los videos se guardar√°n en la misma carpeta seleccionada</li>
                </ol>
            </div>

            <form id="generation-form">
                <div class="form-group">
                    <label>Paso 1: Seleccionar Carpeta con Imagen</label>
                    <input type="file" id="folder-input" webkitdirectory directory style="display: none;">
                    <button type="button" class="btn-select-folder" onclick="document.getElementById('folder-input').click()">
                        üìÅ Seleccionar Carpeta
                    </button>

                    <div class="folder-info" id="folder-info">
                        <p><strong>Carpeta:</strong> <span id="folder-path"></span></p>
                        <p><strong>Imagen encontrada:</strong> <span id="image-name"></span></p>
                        <img id="image-preview" class="image-preview" alt="Preview">
                    </div>
                </div>

                <div class="form-group">
                    <label for="prompt-text">Paso 2: Descripci√≥n del Movimiento (Opcional)</label>
                    <textarea id="prompt-text" rows="3"
                        placeholder="Describe el movimiento o acci√≥n que deseas ver en el video. Ej: 'la persona sonr√≠e y mueve la cabeza suavemente', 'zoom lento hacia adelante', etc. Si se deja vac√≠o, se generar√° movimiento natural autom√°tico."
                        style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group">
                    <label>Paso 3: Generar Videos</label>
                    <div class="info-box" style="margin-bottom: 1rem;">
                        <p style="margin: 0; font-weight: 600;">‚ú® Se generar√°n autom√°ticamente 2 versiones:</p>
                        <ul style="margin: 0.5rem 0 0 1.5rem;">
                            <li><strong>Alta Calidad:</strong> video_high_quality.mp4 (~8-10 MB)</li>
                            <li><strong>Baja Calidad:</strong> video_low_quality.mp4 (~2-3 MB)</li>
                        </ul>
                    </div>
                    <button type="submit" class="btn-generate" id="btn-generate" disabled>
                        üé¨ Generar Videos con Gen-4 Turbo
                    </button>
                </div>
            </form>

            <div class="status-panel" id="status-panel">
                <h3 id="status-title">Procesando...</h3>
                <p id="status-message"></p>
                <div id="status-details"></div>
            </div>

            <div class="video-preview" id="video-preview" style="display: none;">
                <h3>Videos Generados</h3>
                <div id="videos-container"></div>
            </div>
        </div>
        </div>

        <!-- TAB 2: Estad√≠sticas del Cuestionario -->
        <div id="tab-stats" class="tab-content">
            <div class="section">
                <h2>Estad√≠sticas del Cuestionario "Real o Fake"</h2>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <h3>Total Participantes</h3>
                        <div class="stat-value" id="stat-total">-</div>
                        <div class="stat-label">encuestas completadas</div>
                    </div>

                    <div class="stat-card">
                        <h3>Edad Promedio</h3>
                        <div class="stat-value" id="stat-edad">-</div>
                        <div class="stat-label">a√±os</div>
                    </div>

                    <div class="stat-card">
                        <h3>Distribuci√≥n de G√©nero</h3>
                        <div class="stat-value" style="font-size: 1.5rem;" id="stat-genero">-</div>
                        <div class="stat-label">participantes</div>
                    </div>

                    <div class="stat-card">
                        <h3>Total de Respuestas</h3>
                        <div class="stat-value" id="stat-respuestas">-</div>
                        <div class="stat-label">videos evaluados</div>
                    </div>
                </div>

                <div class="download-section">
                    <h3>Descargar Datos del Experimento</h3>
                    <p style="margin-bottom: 1.5rem;">Exporta todos los datos recopilados en formato CSV para an√°lisis en Excel</p>

                    <button class="btn-download" onclick="downloadCSV()">
                        üìä Descargar CSV Completo
                    </button>

                    <button class="btn-download" onclick="downloadJSON()" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                        üìÅ Descargar JSON (Raw Data)
                    </button>

                    <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                        √öltima actualizaci√≥n: <span id="last-update">-</span>
                    </p>
                </div>

                <div class="info-box" style="margin-top: 2rem;">
                    <h4>An√°lisis Detallado</h4>
                    <p>Para un an√°lisis estad√≠stico m√°s profundo, usa el script de Python:</p>
                    <code style="background: white; padding: 0.5rem; border-radius: 4px; display: block; margin-top: 0.5rem;">
                        python analizar_resultados.py
                    </code>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Generador de Videos Local - Runway Gen-4 Turbo</p>
        </div>
    </footer>

    <script>
        let selectedFolder = null;
        let selectedImage = null;

        // Handle folder selection
        document.getElementById('folder-input').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);

            if (files.length === 0) {
                alert('No se seleccionaron archivos');
                return;
            }

            // Get folder path from first file
            const firstFile = files[0];
            const folderPath = firstFile.webkitRelativePath.split('/')[0];

            // Find first image file
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
            const imageFile = files.find(file => {
                const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                return imageExtensions.includes(ext);
            });

            if (!imageFile) {
                alert('No se encontr√≥ ninguna imagen en la carpeta seleccionada.\nFormatos soportados: JPG, PNG, GIF, BMP, WEBP');
                return;
            }

            selectedFolder = folderPath;
            selectedImage = imageFile;

            // Show folder info
            document.getElementById('folder-path').textContent = folderPath;
            document.getElementById('image-name').textContent = imageFile.name;
            document.getElementById('folder-info').classList.add('visible');

            // Show image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('image-preview');
                preview.src = e.target.result;
                preview.classList.add('visible');
            };
            reader.readAsDataURL(imageFile);

            // Enable generate button
            document.getElementById('btn-generate').disabled = false;
        });

        // Handle form submission
        document.getElementById('generation-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Verificar si est√° ejecut√°ndose localmente
            if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
                alert('‚ö†Ô∏è ATENCI√ìN: Esta funcionalidad requiere ejecuci√≥n local.\n\nPara usar el generador de videos:\n1. Descarga el c√≥digo desde GitHub\n2. Ejecuta "python server.py" en tu terminal\n3. Abre http://localhost:8000/generador-local.html\n\nLa versi√≥n online solo muestra la interfaz de demostraci√≥n.');
                return;
            }

            if (!selectedImage) {
                alert('Por favor selecciona una carpeta con una imagen primero');
                return;
            }

            const promptText = document.getElementById('prompt-text').value.trim();

            // Show loading status
            const statusPanel = document.getElementById('status-panel');
            statusPanel.className = 'status-panel visible loading';
            document.getElementById('status-title').textContent = 'Generando Videos...';
            document.getElementById('status-message').textContent = 'Subiendo imagen y generando 2 videos con Gen-4 Turbo. Esto puede tomar 2-4 minutos.';
            document.getElementById('status-details').innerHTML = `
                <p><strong>Carpeta:</strong> ${selectedFolder}</p>
                <p><strong>Imagen:</strong> ${selectedImage.name}</p>
                <p><strong>Prompt:</strong> ${promptText || '(Movimiento autom√°tico)'}</p>
            `;

            // Disable button
            const btnGenerate = document.getElementById('btn-generate');
            btnGenerate.disabled = true;
            btnGenerate.textContent = '‚è≥ Generando...';

            try {
                // Create FormData to send image file
                const formData = new FormData();
                formData.append('image', selectedImage);
                formData.append('folderPath', selectedFolder);
                formData.append('promptText', promptText);

                const response = await fetch('/generate-from-local-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Show success
                    statusPanel.className = 'status-panel visible success';
                    document.getElementById('status-title').textContent = '‚úÖ Videos Generados Exitosamente';
                    document.getElementById('status-message').textContent = result.message;
                    document.getElementById('status-details').innerHTML = `
                        <p><strong>Carpeta:</strong> ${result.folderPath}</p>
                        <p><strong>Imagen usada:</strong> ${result.imageUsed}</p>
                    `;

                    // Show video previews
                    const videosContainer = document.getElementById('videos-container');
                    videosContainer.innerHTML = '';

                    // Display both videos
                    Object.keys(result.videos).forEach(quality => {
                        const videoData = result.videos[quality];
                        const videoDiv = document.createElement('div');
                        videoDiv.style.marginBottom = '2rem';
                        videoDiv.innerHTML = `
                            <h4>Calidad ${videoData.label}</h4>
                            <video controls style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
                                <source src="${videoData.videoPath}" type="video/mp4">
                            </video>
                            <p><strong>Archivo:</strong> ${videoData.fileName}</p>
                            <p><strong>Tama√±o:</strong> ${videoData.fileSize}</p>
                            <p><strong>Duraci√≥n:</strong> ${videoData.duration} segundos</p>
                            <p><strong>Task ID:</strong> ${videoData.taskId}</p>
                        `;
                        videosContainer.appendChild(videoDiv);
                    });

                    document.getElementById('video-preview').style.display = 'block';

                } else {
                    throw new Error(result.message || 'Error desconocido');
                }

            } catch (error) {
                statusPanel.className = 'status-panel visible error';
                document.getElementById('status-title').textContent = '‚ùå Error al Generar Videos';
                document.getElementById('status-message').textContent = error.message;
                document.getElementById('status-details').innerHTML = `
                    <p>Por favor verifica:</p>
                    <ul>
                        <li>Que el servidor PHP est√© ejecut√°ndose</li>
                        <li>Que la API key de Runway ML sea v√°lida</li>
                        <li>Que tengas conexi√≥n a internet</li>
                        <li>Que la carpeta tenga permisos de escritura</li>
                    </ul>
                `;
            } finally {
                btnGenerate.disabled = false;
                btnGenerate.textContent = 'üé¨ Generar Videos con Gen-4 Turbo';
            }
        });

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';

            // Add active class to clicked tab button
            event.target.classList.add('active');

            // Load stats when switching to stats tab
            if (tabName === 'stats') {
                loadStats();
            }
        }

        // Load statistics from server
        async function loadStats() {
            // Verificar si est√° ejecut√°ndose localmente
            if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
                document.getElementById('stat-total').textContent = '--';
                document.getElementById('stat-edad').textContent = '--';
                document.getElementById('stat-genero').innerHTML = '<strong style="color: #e67e22;">‚ö†Ô∏è Requiere servidor local</strong>';
                document.getElementById('stat-respuestas').textContent = '--';
                alert('‚ö†Ô∏è Las estad√≠sticas solo est√°n disponibles en ejecuci√≥n local.\n\nPara ver estad√≠sticas reales:\n1. Descarga el c√≥digo desde GitHub\n2. Ejecuta "python server.py"\n3. Abre http://localhost:8000/generador-local.html');
                return;
            }

            try {
                const response = await fetch('/get-stats');
                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;

                    // Update stat cards
                    document.getElementById('stat-total').textContent = stats.total_participantes;
                    document.getElementById('stat-edad').textContent = stats.edad_promedio.toFixed(1) + ' a√±os';

                    // Gender distribution
                    const generoText = `
                        Masculino: ${stats.genero.masculino} (${stats.genero.porcentaje_masculino}%)<br>
                        Femenino: ${stats.genero.femenino} (${stats.genero.porcentaje_femenino}%)
                        ${stats.genero.otro > 0 ? '<br>Otro: ' + stats.genero.otro + ' (' + stats.genero.porcentaje_otro + '%)' : ''}
                    `;
                    document.getElementById('stat-genero').innerHTML = generoText;
                    document.getElementById('stat-respuestas').textContent = stats.total_respuestas;

                } else {
                    console.error('Error al cargar estad√≠sticas:', data.message);
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                document.getElementById('stat-total').textContent = 'Error';
                document.getElementById('stat-edad').textContent = 'Error';
                document.getElementById('stat-genero').textContent = 'Error al cargar datos';
                document.getElementById('stat-respuestas').textContent = 'Error';
            }
        }

        // Download CSV
        async function downloadCSV() {
            if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
                alert('‚ö†Ô∏è La descarga de datos requiere ejecuci√≥n local.\n\nEjecuta el servidor local con "python server.py" para descargar datos.');
                return;
            }
            try {
                const response = await fetch('/export-csv');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resultados_experimento_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Error al descargar CSV: ' + error.message);
            }
        }

        // Download JSON
        async function downloadJSON() {
            if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
                alert('‚ö†Ô∏è La descarga de datos requiere ejecuci√≥n local.\n\nEjecuta el servidor local con "python server.py" para descargar datos.');
                return;
            }
            try {
                const response = await fetch('/export-json');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resultados_experimento_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Error al descargar JSON: ' + error.message);
            }
        }
    </script>
</body>
</html>
