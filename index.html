<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <title>Experimento: Detecci√≥n de Videos Generados por IA</title>
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #1a5490;
            --secondary-color: #2c7ab5;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --bg-light: #ecf0f1;
            --bg-white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-dark);
            background-color: var(--bg-light);
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        header h1 {
            color: white;
            margin: 0 0 0.5rem 0;
            font-size: 1.6rem;
            font-weight: 600;
        }

        header .subtitle {
            margin: 0;
            font-size: 1rem;
            opacity: 0.9;
            font-style: italic;
        }

        header .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .experiment-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0.5rem;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin: 0.5rem auto;
            background-color: #000;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .video-container iframe {
            width: 100%;
            height: 400px;
            display: block;
            border: none;
        }

        .slider-container {
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 4px;
        }

        .slider-container h3 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .label-real {
            color: var(--success-color);
        }

        .label-fake {
            color: var(--danger-color);
        }

        .slider-track {
            position: relative;
            height: 50px;
            margin: 0.5rem 0;
        }

        .slider-input {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right,
                #27ae60 0%, #27ae60 20%,
                #95a5a6 50%,
                #e74c3c 80%, #e74c3c 100%);
            outline: none;
            -webkit-appearance: none;
            margin: 20px 0;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-color);
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .slider-input::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 14px rgba(0,0,0,0.4);
        }

        .slider-input::-moz-range-thumb {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-color);
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .slider-value-display {
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0.25rem 0;
            color: var(--primary-color);
        }

        .slider-markers {
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            margin-top: -10px;
        }

        .marker {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .progress-info {
            text-align: center;
            padding: 0.4rem;
            background-color: #e3f2fd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .progress-info h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 0.85rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 25px;
            background-color: var(--bg-light);
            border-radius: 12px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--success-color) 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .btn-next {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-next:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .form-group {
            margin-bottom: 0.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-group select,
        .form-group input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .instructions-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .instructions-box h3 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .instructions-box ul {
            margin-left: 1.5rem;
        }

        .instructions-box li {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .thank-you-message {
            text-align: center;
            padding: 3rem;
        }

        .thank-you-message h2 {
            color: var(--success-color);
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .consent-box {
            background-color: white;
            border: 2px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .consent-box label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .consent-box input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Experimento: Detecci√≥n de Videos Generados por IA</h1>
            <p class="subtitle">Universidad - Estudio sobre percepci√≥n de contenido sint√©tico</p>
        </div>
    </header>

    <main class="container experiment-container">
        <!-- PASO 1: Introducci√≥n y consentimiento -->
        <div id="step-intro" class="step active">
            <div class="section">
                <div style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); padding: 1.5rem; border-radius: 8px; color: white; text-align: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0; font-size: 1.8rem;">üé¨ Experimento de Detecci√≥n de Videos IA</h2>
                </div>

                <div class="instructions-box">
                    <h3 style="text-align: center;">üìã Informaci√≥n sobre el Estudio</h3>
                    <p><strong>Investigador Principal:</strong> Silvia Charles Roland (scrolland@hotmail.com)</p>
                    <p><strong>N√∫mero de videos a evaluar:</strong> 20 videos</p>
                    <p><strong>Duraci√≥n estimada:</strong> 10-15 minutos</p>

                    <h4>Objetivo del Estudio:</h4>
                    <p>Este experimento busca entender c√≥mo las personas perciben y distinguen entre videos reales y videos generados por inteligencia artificial.</p>

                    <h4>Tem√°tica de los Videos:</h4>
                    <p>Los videos que ver√°s muestran <strong>situaciones tur√≠sticas</strong>: paisajes, monumentos, personas en entornos vacacionales, escenas de viajes, etc. Ver√°s tanto contenido de entretenimiento como informativo relacionado con destinos y experiencias tur√≠sticas.</p>

                    <h4>¬øQu√© tendr√°s que hacer?</h4>
                    <ul>
                        <li><strong>Ver√°s 20 videos</strong> cortos (cada uno dura entre 5-10 segundos)</li>
                        <li>Para cada video, deber√°s <strong>indicar si crees que es REAL o FAKE (generado por IA)</strong></li>
                        <li>Si consideras que el video es <strong>FAKE</strong>, te pediremos que valores 3 aspectos usando sliders del 0 al 10:
                            <ul>
                                <li><strong>Coherencia de elementos visuales en primer plano</strong></li>
                                <li><strong>Naturalidad del movimiento</strong></li>
                                <li><strong>Coherencia de iluminaci√≥n y sombras</strong></li>
                            </ul>
                            <small>(0 = Muy mal / Muy artificial | 10 = Perfecto / Muy natural)</small>
                        </li>
                        <li>No hay respuestas correctas o incorrectas, queremos tu <strong>percepci√≥n honesta</strong></li>
                    </ul>

                    <h4>Uso de los Datos:</h4>
                    <p>Tus respuestas ser√°n completamente <strong>an√≥nimas</strong> y se utilizar√°n √∫nicamente con fines de investigaci√≥n acad√©mica. Los datos se almacenar√°n de forma segura y no se compartir√°n identificadores personales.</p>
                </div>

                <div class="consent-box">
                    <label>
                        <input type="checkbox" id="consent-check" required>
                        <span>He le√≠do la informaci√≥n del estudio y acepto participar voluntariamente. Entiendo que puedo abandonar el experimento en cualquier momento.</span>
                    </label>
                </div>

                <h3>Datos Demogr√°ficos</h3>
                <div class="form-group">
                    <label for="genero">G√©nero *</label>
                    <select id="genero" required>
                        <option value="">Selecciona...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edad">Edad *</label>
                    <input type="number" id="edad" min="18" max="99" required placeholder="Ej: 25">
                </div>

                <div class="form-group">
                    <label for="consumo-videos">Nivel de consumo habitual de videos *</label>
                    <select id="consumo-videos" required>
                        <option value="">Selecciona...</option>
                        <option value="Muy poco/nada">Muy poco/nada</option>
                        <option value="Habitualmente/Muy habitualmente">Habitualmente/Muy habitualmente</option>
                    </select>
                </div>

                <button class="btn-next" onclick="startExperiment()">Comenzar Experimento</button>
            </div>
        </div>

        <!-- PASO 2: Videos -->
        <div id="step-videos" class="step">
            <div class="progress-info">
                <h3>Video <span id="current-video">1</span> de 20</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progress-bar" style="width: 5%;">5%</div>
                </div>
            </div>

            <div class="video-container">
                <iframe id="video-player" src="" allow="autoplay"></iframe>
            </div>

            <!-- Pregunta principal: Real o Fake -->
            <div class="slider-container">
                <h3>¬øEste video es real o generado por IA?</h3>
                <div style="display: flex; justify-content: center; gap: 2rem; margin: 1rem 0;">
                    <label style="display: flex; align-items: center; padding: 1rem 2rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s;" id="label-real">
                        <input type="radio" name="respuesta-tipo" value="real" style="margin-right: 0.75rem; width: 22px; height: 22px; cursor: pointer;" onchange="onTipoChange('real')">
                        <span style="font-size: 1.1rem; font-weight: 600; color: var(--success-color);">REAL</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 1rem 2rem; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s;" id="label-fake">
                        <input type="radio" name="respuesta-tipo" value="fake" style="margin-right: 0.75rem; width: 22px; height: 22px; cursor: pointer;" onchange="onTipoChange('fake')">
                        <span style="font-size: 1.1rem; font-weight: 600; color: var(--danger-color);">FAKE (IA)</span>
                    </label>
                </div>
            </div>

            <!-- Sliders condicionales (solo si elige FAKE) -->
            <div id="sliders-fake-container" class="slider-container" style="display: none;">
                <h3 style="margin-bottom: 1rem;">Valora los siguientes aspectos del video:</h3>
                <p style="text-align: center; color: var(--text-light); margin-bottom: 1rem;">
                    <small>0 = Muy mal / Muy artificial | 10 = Perfecto / Muy natural</small>
                </p>

                <!-- Slider 1: Coherencia elementos visuales -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Coherencia de los elementos visuales en primer plano</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.8rem; color: var(--danger-color);">0</span>
                        <input type="range" id="slider-coherencia" class="slider-input" min="0" max="10" value="5" oninput="updateSliderDisplay('coherencia', this.value)" style="flex: 1;">
                        <span style="font-size: 0.8rem; color: var(--success-color);">10</span>
                        <span id="value-coherencia" style="font-weight: bold; min-width: 30px; text-align: center;">5</span>
                    </div>
                </div>

                <!-- Slider 2: Naturalidad movimiento -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Naturalidad del movimiento observado en el video</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.8rem; color: var(--danger-color);">0</span>
                        <input type="range" id="slider-movimiento" class="slider-input" min="0" max="10" value="5" oninput="updateSliderDisplay('movimiento', this.value)" style="flex: 1;">
                        <span style="font-size: 0.8rem; color: var(--success-color);">10</span>
                        <span id="value-movimiento" style="font-weight: bold; min-width: 30px; text-align: center;">5</span>
                    </div>
                </div>

                <!-- Slider 3: Coherencia iluminacion -->
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Coherencia de la iluminacion y las sombras del video</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.8rem; color: var(--danger-color);">0</span>
                        <input type="range" id="slider-iluminacion" class="slider-input" min="0" max="10" value="5" oninput="updateSliderDisplay('iluminacion', this.value)" style="flex: 1;">
                        <span style="font-size: 0.8rem; color: var(--success-color);">10</span>
                        <span id="value-iluminacion" style="font-weight: bold; min-width: 30px; text-align: center;">5</span>
                    </div>
                </div>
            </div>

            <button class="btn-next" onclick="nextVideo()">Siguiente Video ‚Üí</button>
        </div>

        <!-- PASO 3: Finalizaci√≥n -->
        <div id="step-thanks" class="step">
            <div class="section thank-you-message" style="text-align: center;">
                <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 2rem; border-radius: 12px; color: white; margin: 1rem 0;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">¬°Experimento Completado!</h2>
                    <p style="font-size: 1.1rem; margin: 0;">
                        Tus respuestas han sido guardadas exitosamente
                    </p>
                </div>

                <!-- Resultados del participante -->
                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #ff9800;">
                    <h3 style="color: #e65100; text-align: center; margin-bottom: 1rem;">Tus Resultados</h3>
                    <p style="font-size: 1.5rem; font-weight: bold; text-align: center; margin: 0.5rem 0;">
                        Aciertos: <span id="resultado-aciertos" style="color: var(--success-color);">0</span> / <span id="resultado-total">20</span>
                    </p>
                    <p style="font-size: 1.2rem; text-align: center; color: #666;">
                        (<span id="resultado-porcentaje">0</span>% de acierto)
                    </p>
                </div>

                <!-- Videos fallados -->
                <div id="videos-fallados-container" style="background: #fff; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border: 2px solid #e0e0e0; text-align: left; display: none;">
                    <h3 style="color: var(--danger-color); text-align: center; margin-bottom: 1rem;">Videos en los que fallaste</h3>
                    <div id="lista-videos-fallados" style="max-height: 300px; overflow-y: auto;">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; text-align: left;">
                    <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 1rem;">Sobre el Estudio</h3>
                    <p style="margin: 0.5rem 0;">Los videos inclu√≠an grabaciones reales y contenido generado por IA con diferentes niveles de calidad.</p>
                    <p style="margin: 0.5rem 0;"><strong>Objetivo:</strong> Investigar c√≥mo las personas detectan contenido sint√©tico y qu√© caracter√≠sticas visuales despiertan sospechas.</p>
                </div>

                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                    <p style="margin: 0; font-size: 0.95rem;">
                        <strong>Investigador Principal:</strong> Silvia Charles Roland<br>
                        <strong>Universidad:</strong> Universitat de les Illes Balears<br>
                        <strong>Contacto:</strong> <a href="mailto:scrolland@hotmail.com">scrolland@hotmail.com</a>
                    </p>
                </div>

                <p style="margin-top: 2rem; font-size: 1.1rem; color: var(--success-color); font-weight: 600;">
                    ¬°Gracias por contribuir a esta investigacion!
                </p>
            </div>
        </div>
    </main>

    <script>
        // State management
        let experimentState = {
            participanteId: null,
            currentVideo: 0,
            videos: [],
            responses: [],
            startTime: null,
            videoStartTime: null,
            isSubmitting: false
        };

        // Funci√≥n para manejar cambio de tipo (Real/Fake)
        function onTipoChange(tipo) {
            const slidersFakeContainer = document.getElementById('sliders-fake-container');
            const labelReal = document.getElementById('label-real');
            const labelFake = document.getElementById('label-fake');

            // Resetear estilos
            labelReal.style.border = '3px solid transparent';
            labelFake.style.border = '3px solid transparent';

            if (tipo === 'fake') {
                slidersFakeContainer.style.display = 'block';
                labelFake.style.border = '3px solid var(--danger-color)';
                labelFake.style.background = '#ffebee';
            } else {
                slidersFakeContainer.style.display = 'none';
                labelReal.style.border = '3px solid var(--success-color)';
                labelReal.style.background = '#e8f5e9';
            }
        }

        // Funci√≥n para actualizar display de sliders
        function updateSliderDisplay(tipo, value) {
            document.getElementById('value-' + tipo).textContent = value;
        }

        // Start experiment
        async function startExperiment() {
            // Validate inputs
            const consent = document.getElementById('consent-check').checked;
            const genero = document.getElementById('genero').value;
            const edad = document.getElementById('edad').value;
            const consumoVideos = document.getElementById('consumo-videos').value;

            if (!consent) {
                alert('Debes aceptar el consentimiento informado para continuar.');
                return;
            }

            if (!genero || !edad || !consumoVideos) {
                alert('Por favor completa todos los campos demogr√°ficos.');
                return;
            }

            if (edad < 18) {
                alert('Debes ser mayor de 18 a√±os para participar en este experimento.');
                return;
            }

            // Initialize experiment
            experimentState.participanteId = 'P' + Date.now();
            experimentState.genero = genero;
            experimentState.edad = parseInt(edad);
            experimentState.consumoVideos = consumoVideos;
            experimentState.videos = selectVideosForExperiment();
            experimentState.startTime = Date.now();

            // Show videos step
            document.getElementById('step-intro').classList.remove('active');
            document.getElementById('step-videos').classList.add('active');

            // Load first video
            loadVideo(0);
        }

        // Load video
        function loadVideo(index) {
            if (index >= experimentState.videos.length) {
                finishExperiment();
                return;
            }

            experimentState.currentVideo = index;
            experimentState.videoStartTime = Date.now();

            const video = experimentState.videos[index];
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.src = video.path;

            // Reset radio buttons Real/Fake
            const radios = document.querySelectorAll('input[name="respuesta-tipo"]');
            radios.forEach(radio => radio.checked = false);

            // Reset estilos de labels
            const labelReal = document.getElementById('label-real');
            const labelFake = document.getElementById('label-fake');
            labelReal.style.border = '3px solid transparent';
            labelReal.style.background = '#f8f9fa';
            labelFake.style.border = '3px solid transparent';
            labelFake.style.background = '#f8f9fa';

            // Ocultar sliders condicionales
            document.getElementById('sliders-fake-container').style.display = 'none';

            // Reset sliders a valor 5
            document.getElementById('slider-coherencia').value = 5;
            document.getElementById('slider-movimiento').value = 5;
            document.getElementById('slider-iluminacion').value = 5;
            document.getElementById('value-coherencia').textContent = '5';
            document.getElementById('value-movimiento').textContent = '5';
            document.getElementById('value-iluminacion').textContent = '5';

            // Update progress
            const progress = ((index + 1) / experimentState.videos.length) * 100;
            document.getElementById('current-video').textContent = index + 1;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-bar').textContent = Math.round(progress) + '%';
        }

        // Next video
        async function nextVideo() {
            const respuestaTipoRadio = document.querySelector('input[name="respuesta-tipo"]:checked');
            const timeSpent = Math.round((Date.now() - experimentState.videoStartTime) / 1000);

            // Validar que haya seleccionado Real o Fake
            if (!respuestaTipoRadio) {
                alert('Por favor, indica si el video es REAL o FAKE.');
                return;
            }

            const respuestaTipo = respuestaTipoRadio.value; // 'real' o 'fake'
            const currentVideo = experimentState.videos[experimentState.currentVideo];

            // Obtener valores de sliders (solo relevantes si eligi√≥ fake)
            let sliderCoherencia = null;
            let sliderMovimiento = null;
            let sliderIluminacion = null;

            if (respuestaTipo === 'fake') {
                sliderCoherencia = parseInt(document.getElementById('slider-coherencia').value);
                sliderMovimiento = parseInt(document.getElementById('slider-movimiento').value);
                sliderIluminacion = parseInt(document.getElementById('slider-iluminacion').value);
            }

            // Determinar si acert√≥
            const esRealElVideo = !currentVideo.es_fake;
            const usuarioDijoReal = respuestaTipo === 'real';
            const acierto = esRealElVideo === usuarioDijoReal;

            if (acierto) {
                swal('¬°Acertaste!', '', 'success');
            }else{
                swal('¬°Fallaste!', '', 'error');
            }

            // Save response with all fields
            const response = {
                numero: experimentState.currentVideo + 1,
                path: currentVideo.path,
                tipo_contenido: currentVideo.tipo,
                es_fake_real: currentVideo.es_fake,
                evidente: currentVideo.es_evidente || false,
                calidad: currentVideo.quality || currentVideo.calidad || 'desconocida',
                respuesta_usuario: respuestaTipo,
                acierto: acierto,
                slider_coherencia: sliderCoherencia,
                slider_movimiento: sliderMovimiento,
                slider_iluminacion: sliderIluminacion,
                tiempo: Math.round(timeSpent),
                es_placebo: currentVideo.es_evidente || false
            };

            experimentState.responses.push(response);
            
            
            // Load next video or finish
            loadVideo(experimentState.currentVideo + 1);
        }

        // Finish experiment
        async function finishExperiment() {
            // Prevenir env√≠os m√∫ltiples
            if (experimentState.isSubmitting) {
                console.log('Ya se est√° enviando, ignorando llamada duplicada');
                return;
            }

            experimentState.isSubmitting = true;

            // Calcular resultados
            const totalVideos = experimentState.responses.length;
            const aciertos = experimentState.responses.filter(r => r.acierto).length;
            const porcentaje = Math.round((aciertos / totalVideos) * 100);
            const videosFallados = experimentState.responses.filter(r => !r.acierto);

            const data = {
                participante_id: experimentState.participanteId,
                genero: experimentState.genero,
                edad: experimentState.edad,
                consumo_videos: experimentState.consumoVideos,
                fecha_inicio: new Date(experimentState.startTime).toISOString(),
                fecha_finalizacion: new Date().toISOString(),
                total_aciertos: aciertos,
                total_videos: totalVideos,
                porcentaje_acierto: porcentaje,
                respuestas: experimentState.responses
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                // Mostrar resultados
                mostrarResultados(aciertos, totalVideos, porcentaje, videosFallados);

                document.getElementById('step-videos').classList.remove('active');
                document.getElementById('step-thanks').classList.add('active');

            } catch (error) {
                console.error('Error:', error);
                mostrarResultados(aciertos, totalVideos, porcentaje, videosFallados);
                document.getElementById('step-videos').classList.remove('active');
                document.getElementById('step-thanks').classList.add('active');
            }
        }

        // Mostrar resultados en pantalla final
        function mostrarResultados(aciertos, total, porcentaje, videosFallados) {
            document.getElementById('resultado-aciertos').textContent = aciertos;
            document.getElementById('resultado-total').textContent = total;
            document.getElementById('resultado-porcentaje').textContent = porcentaje;

            // Si hay videos fallados, mostrar la lista
            if (videosFallados.length > 0) {
                const container = document.getElementById('videos-fallados-container');
                const lista = document.getElementById('lista-videos-fallados');
                container.style.display = 'block';

                let html = '';
                videosFallados.forEach((video, index) => {
                    const realOFake = video.es_fake_real ? 'FAKE (IA)' : 'REAL';
                    const colorRespuesta = video.es_fake_real ? 'var(--danger-color)' : 'var(--success-color)';
                    const tuRespuesta = video.respuesta_usuario === 'real' ? 'REAL' : 'FAKE';

                    html += `
                        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid ${colorRespuesta};">
                            <p style="margin: 0; font-weight: 600;">Video ${video.numero}</p>
                            <p style="margin: 0.25rem 0; font-size: 0.9rem;">
                                Tu respuesta: <strong>${tuRespuesta}</strong> |
                                Correcto: <strong style="color: ${colorRespuesta};">${realOFake}</strong>
                            </p>
                        </div>
                    `;
                });

                lista.innerHTML = html;
            }
        }

        // CONFIGURACI√ìN GOOGLE SHEETS
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwJskx0d2S5frpxSa7Tzap9We1UwdU8qvfXu2Ha-Nol6wCk9M_SIPL7aUQmlgoHn77/exec';

        // Configuraci√≥n de videos
        // Helper function para crear URL de Google Drive con autoplay
        const driveUrl = (id) => `https://drive.google.com/file/d/${id}/preview`;

        // NUEVA ESTRUCTURA: 3 carpetas (fakes, reales, placebo)
        // Carpeta: https://drive.google.com/drive/u/2/folders/1iwUNV-Z2t6GViM4FDRI0TbKpeTdACH5b
        const VIDEOS_POOL = {
            // Videos FAKE (generados por IA) - f1 a f65
            fakes: [
                driveUrl('1M1CJXriNaUlsSg-vUAbjfQsHIrx00gFJ'),  // f1
                driveUrl('1YrsnWlCqkDqFh2xGKb0u0gTlKxtLHDSe'),  // f2
                driveUrl('1_exAXRc2FA6-D107Zp_X2j_l79JDA9ET'),  // f3
                driveUrl('1fDz5mJKnLJQ4B6QEvfKLqg3TCNkNtMfJ'),  // f4
                driveUrl('1ApR0uUtx88IszpCSkQUN298ys3kP2a9n'),  // f5
                driveUrl('13FPSfheXcjOL2XRR7I1Iwd1meFW0K0Fp'),  // f6
                driveUrl('1npH9Y721WiisPdxtutaCDOP2c9UMSNRc'),  // f7
                driveUrl('1jR-H-iLIsgzogZkXzFeqywa8Fgy20plD'),  // f8
                driveUrl('1puyZvOBModsyau2qQEQA9i8zRoZJ0IPq'),  // f9
                driveUrl('1kuzPYErUbp08pjkye5K65ON_UmacQdXL'),  // f10
                driveUrl('1ulDzgwm7_efdet8KfPZ3NS9SqGIvAoUN'),  // f11
                driveUrl('1mPHVJrYiqEqRLck3j6u_RLWh86x7lfAb'),  // f12
                driveUrl('1kssUdSN9rJUFm3Zf7_xiZSqz9_p_kJWp'),  // f13
                driveUrl('15R7olSWK64wD8fc--S4-V3szmyoQSH-O'),  // f14
                driveUrl('1DX6qGDh6LSFZIRl-EyP8rFRVTgucVBT_'),  // f15
                driveUrl('17FsN1JjhrOLgmOkgacCwi6CkP4HoQ8eH'),  // f16
                driveUrl('1P05JPA8kpd9ciHCn7ASsUq6xV_b3dFia'),  // f17
                driveUrl('15ePzsrGHqgZ5jN5H0FoX6KskOnbJ_DaI'),  // f18
                driveUrl('1iZs8gMjT4AHhrwQoglpZ5ADuto-kXVPk'),  // f19
                driveUrl('1ZYj9RFR5r7RAjyv-5EgDMkLycSUW0HGW'),  // f20
                driveUrl('1xuJyGFvAgJjhpMpJryuQY4fjEBKMZDR2'),  // f21
                driveUrl('1F1YfyuB_BUwM7-p5kOxGbfwx6kQs2_wD'),  // f22
                driveUrl('1Fysf8_2NJvTuAtMV7fzC-q415OowyiZx'),  // f23
                driveUrl('1Efg7aiExImTZD7nACfVTjjV7Rv1gbKn4'),  // f24
                driveUrl('1UC-zfw4qXrZyPddmfQd0_81skzgrT9gt'),  // f25
                driveUrl('1LV0Idg0mWyiiLZSpiYL8JevbxemUUxr2'),  // f26
                driveUrl('1WWHQZ2TawooMCjiPeEriOrFG9I3lHr6A'),  // f27
                driveUrl('1FVSrSySJE9vai-Y5cSF-Yk9d5rZKWrkt'),  // f28
                driveUrl('18aCuLA4OsREynsEdtxPWz0YmGX5Jnmy1'),  // f29
                driveUrl('1VeKqBTXrj1_koDjVWA2kzzDriuJUfrFn'),  // f30
                driveUrl('1o7zVx1YsE2mVABQjsr16A3CQVeM9v24W'),  // f31
                driveUrl('10-euOgkD7RA00W-vGxu_panOPsC8wn9C'),  // f32
                driveUrl('1nxQtKO4CNLaArb0VcjCVWfOvUGUilNci'),  // f33
                driveUrl('1SlLthIflwJImlA8OIFMGp9j7wseAPuKb'),  // f34
                driveUrl('1VX-fSYo7vSmU3TiUqpau2OaqzCYc__d6'),  // f35
                driveUrl('1wLmcGIdkBwXwajn46X9tsC9PKxiurbwW'),  // f36
                driveUrl('1518Enxf1vmAVOMAPk_JmJl-UUXBRE-kc'),  // f37
                driveUrl('1NZgc5yvYpORyVVVwSJyER_6lEzIAzbLt'),  // f38
                driveUrl('1TKiLZWxxV3EEF3g9WhRQ-Vqd76zQHUHQ'),  // f39
                driveUrl('10N9fFTVvUyJpmXWgWJ3q1d6IdMLCLns6'),  // f40
                driveUrl('1Nr4GHuVf61ui30ViK_JuzDG4XNCXmjWk'),  // f41
                driveUrl('1OM8jK0-_6U5PMG1ji33rDcK5hQ5iFux3'),  // f42
                driveUrl('1IVkrH-g032nGZ6dBopKVTsVdFDLXLmwQ'),  // f43
                driveUrl('1JPkQq4vDaAgD0kpFVTuKzxXXVHWoJFa3'),  // f44
                driveUrl('1sR0g6poLmCvEymk4gII2pOzAhGONDV0W'),  // f45
                driveUrl('15pYuwDUE5cCBK4Yxd3bbxyBx_sN3QuJ-'),  // f46
                driveUrl('1rMUViJs37JAx1OhLIzJXKuQ64NXUPPU_'),  // f47
                driveUrl('1GZMunRx8sz52M86oEVjGlZ-yddU5KVmB'),  // f48
                driveUrl('18tQdvBgeQFm5BStAVqjUQKAdSUdWQmoh'),  // f49
                driveUrl('1BNYEqFMZMDu6PPVSj1YPSXkKuQ3wIiCC'),  // f50
                driveUrl('1saGJiUic4FlvD3IYg5JBjOnC2qpwE4lI'),  // f51
                driveUrl('1gpn6mx0vt6yH0EoaWnMgRgFWQChgbbWG'),  // f52
                driveUrl('1ZqoLFF_nW8vSWaPm6q79QKaljns-KlAx'),  // f53
                driveUrl('1fY6nwAN7wTKn9fmcZPxnkTnrKDVS3WnK'),  // f54
                driveUrl('1y62Jz3SVt_T9GaF7fBknlZA5egoHCZ9A'),  // f55
                driveUrl('12q1TyQcjuStYk6GsD5NgN5deyz8lpjjq'),  // f56
                driveUrl('1ZGXKnsD1065K47gaA0xAiLalAM7bz6ab'),  // f57
                driveUrl('1A-WitIKQbv5VrLCTQaHwfKf7PgmvOW1l'),  // f58
                driveUrl('1eQ5iQldAdVTHflOzm1LqD9aQx7G-THus'),  // f59
                driveUrl('1rRTZcwvWD-cepV0d0pjjnSGjsfOkf-35'),  // f60
                driveUrl('10Yn23ySuNZQzTQQXmVKdwF5Mgi5WnIey'),  // f61
                driveUrl('1Z0owO_s3J5wT5y_IGPkVAaZkGX-Zf5o8'),  // f62
                driveUrl('1CAgCJWGE-qY26RZxUhMr-Q87DTeMlZhm'),  // f63
                driveUrl('1otfO25HX36cUpNwYX-aqjiJ_j2hS4Wiu'),  // f64
                driveUrl('14gnToIYa1TG9rnuf45sOQgujK3RfRs4m'),  // f65
            ],

            // Videos REALES (grabaciones reales) - r1 a r65
            reales: [
                driveUrl('1re0k9EUX7h85ZYF3teiepe2T-glz4E60'),  // r1
                driveUrl('1SCjy4SGCjMfB39j-iVXNVU-5w-5iHQFH'),  // r2
                driveUrl('1hx6el1j1shQN60rB_zMSvjefMehg33Iq'),  // r3
                driveUrl('1WHC9d5_W-TPMG9Uyze3M-nb7XDRh9fjB'),  // r4
                driveUrl('1jto4z2_H-zNT8TeeQrawZEhBQhiE1RG3'),  // r5
                driveUrl('1J5oue-l2sIxRfaS3hlWCTgN8crlgKjng'),  // r6
                driveUrl('1wWHW6DcUYngwynW5bxcruXGQCJakyYNr'),  // r7
                driveUrl('1hGMZv-SOn2kH-AO2XdG9qz7QzzrpRfB6'),  // r8
                driveUrl('1aOi1P_p9KCJ9p8Izqa5ougymnJQmBm81'),  // r9
                driveUrl('1FDbPSDD_QeOAh51_8ABLceo4DEMVB93V'),  // r10
                driveUrl('18IiPZsPqok21ZNV7PnGzLLnQ8NMqh1Bd'),  // r11
                driveUrl('161P3Ha2aHFq0c4rkTc8IvlXgL8Wt6swb'),  // r12
                driveUrl('1aOGo5kNPkOTiLLfKCVQkz6-ux6TW2927'),  // r13
                driveUrl('15qHH5ZlSUb2JYYp9JVqdTyZIfGKrQKsH'),  // r14
                driveUrl('1PiqtTKDrD8Ckf_dAE-wV61i-O0oJaK1f'),  // r15
                driveUrl('1Sj9Dwfn-r0v-vR823iPihAA0a8T0AZ5o'),  // r16
                driveUrl('1JifAWASnbWnnX3xR3vqpme4CNwOKqTNV'),  // r17
                driveUrl('1M3Jhu_UTZKX2LE02kjlOGKoL3UlzH_Hh'),  // r18
                driveUrl('1BNCm3qDtnzi93oB2DihYWv9s4LKXEq94'),  // r19
                driveUrl('1H_J9wWx1r8xvuj1A8B9Ziv5c1P7P9LZi'),  // r20
                driveUrl('1L-GPNw1Wge99H09zXgHHDYaB2z2Nwntg'),  // r21
                driveUrl('1WSWnRNzLqmA0pTPWsiXkInfF9D363Flm'),  // r22
                driveUrl('1OtJqkNrseDSpZoVp1bunCBmkpFJ1Qxr9'),  // r23
                driveUrl('1Ccjgh1awKhg8S4ZmvnoulpvQumnETkG_'),  // r24
                driveUrl('1kK7aGwkw9yt5MsKFlPqDhsSKtWBAfR1B'),  // r25
                driveUrl('176YH8DnAkLb0TMFCQ4m3fnRhtudoWZXS'),  // r26
                driveUrl('1gD4vJMg5CRIt1mEjJS7QDfWrH_ZaKqkO'),  // r27
                driveUrl('1pYQOwDpmg6iyckOfpll7jUuRrH2zgFCn'),  // r28
                driveUrl('1AtVGRvNXDl7dObO5GG1Vx0d0aQLR4F_h'),  // r29
                driveUrl('1e8QyroXHV-tr12l_seFDLl4P_M2Q__Sy'),  // r30
                driveUrl('1v1dXrROnuX-0-Itd86M5ohpPUL3-uVYC'),  // r31
                driveUrl('1fqugoq8rdIJKKdQV_H7KPo4Mt5ALwdF7'),  // r32
                driveUrl('1dJTaF8WbvAYRv9xpnJbmZxmaIMfJ-N0v'),  // r33
                driveUrl('1B37gUsNtx97wunA9p_pRBviECHpwSJz_'),  // r34
                driveUrl('1_DVGrVCXkHoEzhjovvB-0AuTo9G3IUVA'),  // r35
                driveUrl('1h9wqDRPuie68JW1wrrfuJ4HxBp44TWRQ'),  // r36
                driveUrl('17Zt8SjpBUTUsAz66CnGOUA0D-EOfdXTB'),  // r37
                driveUrl('1ID7WAvFsMHaXo8P-ChGqHWzy9TmueFPw'),  // r38
                driveUrl('1ybCGjyRiVc3Nb0ytu72mpdLIbhe2GdYz'),  // r39
                driveUrl('1GTozILlwuBW4Ax2v-U-qMxHJ7_KHn12k'),  // r40
                driveUrl('1Ews6oHdTxPCR8C7Qhr6i6779urT1i2Ca'),  // r41
                driveUrl('10vibJfueTHV9Vvc32d5ONrYbIBTWXReL'),  // r42
                driveUrl('1QNkCnJjHoeeZYbwh-FghMIs5ABEmq0OM'),  // r43
                driveUrl('1d9FS6keoJIa1PX3sPxJ7gcL6AuAo04A1'),  // r44
                driveUrl('17BLdBKSg-Xmb3Mw2MuZavYMWtjT5DXEL'),  // r45
                driveUrl('1gaecHXhZAj9izcYBJiK8sS302I_OWgxp'),  // r46
                driveUrl('18VIvtl-V6-E50dNCTFlPngKM-Ykp1Khw'),  // r47
                driveUrl('1d0TtC_DGd9cXbfEUWSXOBL9atkrxvuQ-'),  // r48
                driveUrl('1TZ-NylLffb2HbhbTjomxxumiuBMZTwIu'),  // r49
                driveUrl('1LBb7wsJ_578qIe-ig9wcTmlS7ZH_sj-f'),  // r50
                driveUrl('19D6qHiAddb_5YREI3WS9oO40fKyYSyrh'),  // r51
                driveUrl('1-GRawxFW6UJRt4g5V_9bBav-nOE33cJW'),  // r52
                driveUrl('18pA7m11yx-cAC4fawIFQEkW7HkzHg0n8'),  // r53
                driveUrl('1esyHRG1AOO2vBMjCXOTCXnNyuPGGyPMA'),  // r54
                driveUrl('1ocUDB6oGFvPHExKRg-XcVw-lKlL70ue3'),  // r55
                driveUrl('1dhKdr_imMZE9t-6FuXCFB3NzhTK3vaDx'),  // r56
                driveUrl('1LAMhxfxgewQEnPV2j7R1M-mnvnioGeHk'),  // r57
                driveUrl('1JtM2IDXQDs9D8HqjRhSO4ydtzG7JTs4h'),  // r58
                driveUrl('1lIwC-INvsTMJwhjnruzznnpLuWpRgJa-'),  // r59
                driveUrl('1yLHPWmzEiTlSBVLwDOVeenGX96psUj5l'),  // r60
                driveUrl('1_M76ogCKRlCZCmnwL4kfauWZF_46wzVR'),  // r61
                driveUrl('1ijgmASYGq0SJgenvWNw6np3jboiYDqjn'),  // r62
                driveUrl('1qeKip4HftAe3621KNUtTlR2lkXlaI6Ti'),  // r63
                driveUrl('1-J1pXbm8n5pQlYo9H4pPqBhd68TCAbJR'),  // r64
                driveUrl('1rOSbO9yhXujwoWe27SAnu_BYvzZiEiOf'),  // r65
            ],

            // Videos PLACEBO (control de atenci√≥n) - p1 a p10
            placebo: [
                driveUrl('1uU0Uf_wf60MvaD5qaPktlPc_EuzBdBb5'),  // p1
                driveUrl('1wCOK-esCnDGTxTguXb8T0FOcc7ShicEM'),  // p2
                driveUrl('12As2Ypo-WiF_PHGzQ7U1S0xpdeKd-Yk9'),  // p3
                driveUrl('1RL4lJPYWLMqcTPleHR-BhwHp2doMpl3w'),  // p4
                driveUrl('16N1grDlSV2I8cABFn1iTbP1nz5Kcdn27'),  // p5
                driveUrl('1upiBwXS3rNOFHRW3ykKYxbC5v11Nb2yL'),  // p6
                driveUrl('1mLzzaNR-uhShWIE5bspKbiNNiYLs_GRX'),  // p7
                driveUrl('1QCaFdsT6AToEbXTaWAej8QApkemrJKnJ'),  // p8
                driveUrl('1IFk7FBPHekNsd-qT0lRwg16h80kAvfJb'),  // p9
                driveUrl('1lsovv9l_xFtEyNjCPw8i2ohH-qlZkE4G'),  // p10
            ]
        };

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function selectVideosForExperiment() {
            let selected = [];

            // NUEVA L√ìGICA DE SELECCI√ìN:
            // Total: 20 videos
            // - 4 placebos (control de atenci√≥n)
            // - 8 fakes (videos generados por IA)
            // - 8 reales (videos reales)

            // 1. Seleccionar 4 placebos aleatorios (o todos si hay menos de 4)
            const numPlacebos = Math.min(VIDEOS_POOL.placebo.length, 4);
            const selectedPlacebos = shuffleArray(VIDEOS_POOL.placebo).slice(0, numPlacebos);
            selected.push(...selectedPlacebos.map(path => ({
                path,
                tipo: 'placebo',
                es_fake: true, // Los placebos son videos evidentemente fake (para control de atenci√≥n)
                es_placebo: true
            })));

            // 2. Seleccionar 8 fakes aleatorios
            const selectedFakes = shuffleArray(VIDEOS_POOL.fakes).slice(0, 8);
            selected.push(...selectedFakes.map(path => ({
                path,
                tipo: 'fake',
                es_fake: true,
                es_placebo: false
            })));

            // 3. Seleccionar 8 reales aleatorios
            const selectedReales = shuffleArray(VIDEOS_POOL.reales).slice(0, 8);
            selected.push(...selectedReales.map(path => ({
                path,
                tipo: 'real',
                es_fake: false,
                es_placebo: false
            })));

            // Total: 4 + 8 + 8 = 20 videos
            // Mezclar el orden final
            return shuffleArray(selected);
        }

</script>
</body>
</html>
